(()=>{"use strict";var k={},d=(e,t,n)=>new Promise((r,s)=>{var i=f=>{try{c(n.next(f))}catch(l){s(l)}},a=f=>{try{c(n.throw(f))}catch(l){s(l)}},c=f=>f.done?r(f.value):Promise.resolve(f.value).then(i,a);c((n=n.apply(e,t)).next())});const u=new Map;function P(e){return new ReadableStream({start(t){e.onmessage=({data:n})=>n==="end"?t.close():n==="abort"?t.error("Aborted the download"):t.enqueue(n)},cancel(t){console.log("user aborted",t),e.postMessage({abort:!0})}})}self.onmessage=e=>{if(e.data==="ping")return;const t=e.data,n=t.url||`${self.registration.scope+Math.random()}/${typeof t=="string"?t:t.filename}`,r=e.ports[0],s=new Array(3);s[1]=t,s[2]=r,e.data.readableStream?s[0]=e.data.readableStream:e.data.transferringReadable?r.onmessage=i=>{r.onmessage=null,s[0]=i.data.readableStream}:s[0]=P(r),u.set(n,s),r.postMessage({download:n})};function b(e){const t=u.get(e.request.url),[n,r,s]=t;u.delete(e.request.url);const i=new Headers({"Content-Type":"application/octet-stream; charset=utf-8","Content-Security-Policy":"default-src 'none'","X-Content-Security-Policy":"default-src 'none'","X-WebKit-CSP":"default-src 'none'","X-XSS-Protection":"1; mode=block"}),a=new Headers(r.headers||{});a.has("Content-Length")&&i.set("Content-Length",a.get("Content-Length")),a.has("Content-Disposition")&&i.set("Content-Disposition",a.get("Content-Disposition")),r.size&&(console.warn("Depricated"),i.set("Content-Length",r.size));let c=typeof r=="string"?r:r.filename;c&&(console.warn("Depricated"),c=encodeURIComponent(c).replace(/['()]/g,escape).replace(/\*/g,"%2A"),i.set("Content-Disposition",`attachment; filename*=UTF-8''${c}`)),e.respondWith(new Response(n,{headers:i})),s.postMessage({debug:"Download started"})}self.addEventListener("notificationclick",e=>{console.log("On notification click: ",e.notification.tag),e.notification.close(),e.notification.tag.startsWith("message-")&&e.waitUntil(self.clients.matchAll({type:"window"}).then(t=>{for(const n of t)if(n.url==="/home/messages"&&"focus"in n)return n.focus();return self.clients.openWindow&&self.clients.openWindow("/home/messages"),null}))});const h="precache-4.49.5",L=["vditor",".worker.js","fonts","i.monaco"];function g(e){return!(!e.split("?")[0].split("/").pop()||!e.split("?")[0].split("/").pop().includes("."))}function m(e){return!g(e.url)||e.headers.get("Pragma")==="no-cache"?!1:["get","head","options"].includes(e.method.toLowerCase())}function S(e){return!(!g(e)||L.filter(t=>e.includes(t)).length)}let o=null;function w(){var e;o=JSON.parse(new URLSearchParams(location.search).get("config")),o.hosts||(o.hosts=[]),(e=o.domains)!=null&&e.length||(o.domains=[location.host]),console.log("Config:",o)}self.addEventListener("install",e=>e.waitUntil((()=>d(void 0,null,function*(){if(w(),o!=null&&o.preload){const[t,n]=yield Promise.all([caches.open(h),fetch("/manifest.json").then(s=>s.json())]),r=Object.values(n).filter(S).map(s=>new URL(s,o.preload).toString());yield t.addAll(r)}self.skipWaiting()}))())),self.addEventListener("activate",e=>{w(),e.waitUntil(self.clients.claim());const t=[h];caches.keys().then(n=>n.filter(r=>r.startsWith("precache-")).filter(r=>!t.includes(r)).map(r=>caches.delete(r)))});function y(e){return d(this,null,function*(){const t=m(e);for(const n of o.domains||[]){const r=new URL(e.url);r.host=n;try{console.log("From ",r.toString());const s=yield fetch(r,{method:e.method,credentials:t?"same-origin":"include",headers:e.headers,body:e.body,redirect:e.redirect,keepalive:e.keepalive,referrer:e.referrer,referrerPolicy:e.referrerPolicy,signal:e.signal});if(s.ok)return console.log("Load success from ",r.toString()),s}catch(s){console.warn(r.toString()," Load fail ",s)}}return fetch(e)})}function p(e){const t=new URL(e);return t.pathname.startsWith("/fs/")&&(t.search=""),t.toString()}function R(e){return d(this,null,function*(){const t=p(e.url),n=yield caches.match(t);if(n)return n;console.log(`Caching ${t}`);const[r,s]=yield Promise.all([caches.open(h),y(e)]);return s.ok?(r.put(t,s.clone()),s):fetch(e)})}self.addEventListener("fetch",e=>{if(e.request.url.endsWith("/ping")){e.respondWith(new Response("pong"));return}if(u.get(e.request.url)){b(e);return}if(!["get","post","head"].includes(e.request.method.toLowerCase())||!o)return;const t=new URL(e.request.url),n=o.domains.length>1&&o.domains.includes(t.hostname)&&t.origin===location.origin;o.hosts.some(r=>e.request.url.startsWith(r))&&(m(e.request)?e.respondWith((()=>d(void 0,null,function*(){if(n){const c=o.domains.map(l=>{const C=new URL(e.request.url);return C.host=l,p(C.toString())});return(yield Promise.all(c.map(l=>caches.match(l)))).find(l=>l)||R(e.request)}const r=p(e.request.url),s=yield caches.match(r);if(s)return s;console.log(`Caching ${r}`);const[i,a]=yield Promise.all([caches.open(h),fetch(t,{method:e.request.method,headers:e.request.headers,redirect:e.request.redirect,keepalive:e.request.keepalive,referrer:e.request.referrer,referrerPolicy:e.request.referrerPolicy,signal:e.request.signal})]);return a.ok?(i.put(r,a.clone()),a):(console.log(`Failed to cache ${r}`,a),fetch(e.request))}))()):n&&e.respondWith(y(e.request)))})})();
