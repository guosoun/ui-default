self.addEventListener("install",()=>{self.skipWaiting()});self.addEventListener("activate",e=>{e.waitUntil(self.clients.claim())});const map=new Map;self.onmessage=e=>{if(e.data==="ping")return;const t=e.data,a=t.url||self.registration.scope+Math.random()+"/"+(typeof t=="string"?t:t.filename),s=e.ports[0],n=new Array(3);n[1]=t,n[2]=s,e.data.readableStream?n[0]=e.data.readableStream:e.data.transferringReadable?s.onmessage=l=>{s.onmessage=null,n[0]=l.data.readableStream}:n[0]=createStream(s),map.set(a,n),s.postMessage({download:a})};function createStream(e){return new ReadableStream({start(t){e.onmessage=({data:a})=>{if(a==="end")return t.close();if(a==="abort"){t.error("Aborted the download");return}t.enqueue(a)}},cancel(t){console.log("user aborted",t),e.postMessage({abort:!0})}})}self.onfetch=e=>{const t=e.request.url;if(t.endsWith("/ping"))return e.respondWith(new Response("pong"));const a=map.get(t);if(!a)return null;const[s,n,l]=a;map.delete(t);const o=new Headers({"Content-Type":"application/octet-stream; charset=utf-8","Content-Security-Policy":"default-src 'none'","X-Content-Security-Policy":"default-src 'none'","X-WebKit-CSP":"default-src 'none'","X-XSS-Protection":"1; mode=block"});let r=new Headers(n.headers||{});r.has("Content-Length")&&o.set("Content-Length",r.get("Content-Length")),r.has("Content-Disposition")&&o.set("Content-Disposition",r.get("Content-Disposition")),n.size&&(console.warn("Depricated"),o.set("Content-Length",n.size));let i=typeof n=="string"?n:n.filename;i&&(console.warn("Depricated"),i=encodeURIComponent(i).replace(/['()]/g,escape).replace(/\*/g,"%2A"),o.set("Content-Disposition","attachment; filename*=UTF-8''"+i)),e.respondWith(new Response(s,{headers:o})),l.postMessage({debug:"Download started"})};
